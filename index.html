<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedure Builder Prototype V2</title>
    <!-- js-yaml library for YAML export -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --optional-color: #ffc107;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: #333;
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }

        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        input[type="text"], select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        textarea { min-height: 80px; }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-light { background-color: #e9ecef; color: #212529; border: 1px solid var(--border-color); }

        .navigation-buttons {
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
        }
        
        .definition-card {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #fdfdfd;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .column-definition {
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        /* NEW: Step 5 Sample Card Styles */
        .sample-table-instance {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
        }
        .sample-table-instance h4 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        
        /* NEW: Step 6 Pseudocode Styles */
        .pseudocode-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .blockly-placeholder {
            border: 2px dashed var(--secondary-color);
            border-radius: 5px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: #f5f5f5;
            min-height: 400px;
        }
        #pseudocode-editor {
            font-family: "Courier New", Courier, monospace;
            font-size: 0.95rem;
            min-height: 400px;
            background-color: #2d2d2d;
            color: #f1f1f1;
            border: 1px solid #444;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 8px;
            width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto;
        }
        .modal-views {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem;
        }
        .data-table-container { max-height: 400px; overflow: auto; border: 1px solid var(--border-color); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .data-table th { background-color: var(--light-gray); }
        .data-table td:focus { outline: 2px solid var(--primary-color); background-color: #eef5ff; }

        #json-output, #yaml-output {
            background-color: #2d2d2d; color: #f1f1f1; padding: 1rem;
            border-radius: 5px; white-space: pre; overflow-x: auto; max-height: 400px;
        }
        
        /* Progress Tracker Styles */
        .progress-tracker {
            display: flex; justify-content: space-between; align-items: center;
            margin: 2rem 0; position: relative;
        }
        .progress-line {
            position: absolute; top: 50%; left: 0; right: 0;
            height: 2px; background-color: var(--border-color); z-index: 1;
            transform: translateY(-50%);
        }
        .progress-line-filled {
            position: absolute; left: 0; top: 0; height: 100%;
            background-color: var(--primary-color); transition: width 0.3s ease;
            width: var(--progress-width, 0%);
        }
        .progress-step {
            position: relative; z-index: 2; width: 40px; height: 40px;
            border-radius: 50%; background-color: white; border: 3px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
            color: var(--secondary-color);
        }
        .progress-step.optional { border-style: dashed; }
        .progress-step.completed {
            background-color: var(--primary-color); border-color: var(--primary-color); color: white;
        }
        .progress-step.completed.optional { background-color: var(--optional-color); border-color: var(--optional-color); }
        .progress-step.active {
            border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1);
        }
        .progress-step.active.optional { border-color: var(--optional-color); color: var(--optional-color); }
        .step-label {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            font-size: 0.9rem; white-space: nowrap; color: var(--secondary-color);
        }
        .progress-step.active .step-label,
        .progress-step.completed .step-label { color: var(--primary-color); font-weight: bold; }
        .progress-step.active.optional .step-label,
        .progress-step.completed.optional .step-label { color: var(--optional-color); }
        
        .optional-steps-note {
            text-align: center;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Procedure Builder</h1>
        <p>Follow the steps to define a business procedure, its tables, and its logic.</p>

        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <div class="progress-line"><div class="progress-line-filled"></div></div>
            <div class="progress-step" data-step="1" onclick="app.goToStep(1)">1<div class="step-label">Procedure Details</div></div>
            <div class="progress-step" data-step="2" onclick="app.goToStep(2)">2<div class="step-label">Input Tables</div></div>
            <div class="progress-step" data-step="3" onclick="app.goToStep(3)">3<div class="step-label">Output Tables</div></div>
            <div class="progress-step" data-step="4" onclick="app.goToStep(4)">4<div class="step-label">Review & Export</div></div>
            <div class="progress-step optional" data-step="5" onclick="app.goToStep(5)">5*<div class="step-label">Add Samples*</div></div>
            <div class="progress-step optional" data-step="6" onclick="app.goToStep(6)">6*<div class="step-label">Pseudocode*</div></div>
        </div>

        <div class="optional-steps-note">
            <br>
            <small><em>* Steps marked with asterisks are optional</em></small>
        </div>
        <hr>

        <!-- Step 1: Procedure Details -->
        <div id="step-1" class="wizard-step active">
            <h2>Step 1: Define Procedure Details</h2>
            <div class="form-group"><label for="proc-name">Procedure Name</label><input type="text" id="proc-name" placeholder="e.g., Monthly Customer Churn Calculation"></div>
            <div class="form-group"><label for="proc-summary">Procedure Summary</label><textarea id="proc-summary" placeholder="Describe the purpose of this procedure."></textarea></div>
        </div>

        <!-- Step 2: Input Tables -->
        <div id="step-2" class="wizard-step">
            <h2>Step 2: Define Input Tables</h2><p>These are the table definitions the procedure will read from.</p>
            <div id="input-tables-container"></div>
            <button class="btn btn-success" onclick="app.addTable('input')">+ Add Input Table</button>
        </div>

        <!-- Step 3: Output Tables -->
        <div id="step-3" class="wizard-step">
            <h2>Step 3: Define Output Tables</h2><p>These are the table definitions the procedure will create or write to.</p>
            <div id="output-tables-container"></div>
            <button class="btn btn-success" onclick="app.addTable('output')">+ Add Output Table</button>
        </div>
        
        <!-- Step 4: Review and Export -->
        <div id="step-4" class="wizard-step">
            <h2>Step 4: Review and Export</h2><p>Review the complete procedure definition below. You can download it as JSON or YAML.</p>
            <h3>JSON Output</h3><pre id="json-output"></pre>
            <h3>YAML Output</h3><pre id="yaml-output"></pre>
            <div class="export-buttons" style="margin-top: 1rem;">
                <button class="btn btn-primary" onclick="app.exportFile('json')">Download JSON</button>
                <button class="btn btn-primary" onclick="app.exportFile('yaml')">Download YAML</button>
            </div>
        </div>

        <!-- Step 5: Samples -->
        <div id="step-5" class="wizard-step">
            <h2>Step 5: Define Sample Scenarios (Optional)</h2><p>Provide sample data for the tables you defined. This helps developers understand the business logic with concrete examples.</p>
            <div id="samples-container"></div>
            <button class="btn btn-success" onclick="app.addSample()">+ Add Sample</button>
        </div>

        <!-- Step 6: Pseudocode -->
        <div id="step-6" class="wizard-step">
            <h2>Step 6: Describe Logic (Optional)</h2><p>Use the text editor to write pseudocode or a description of the steps the procedure should take.</p>
            <div class="pseudocode-container">
                <div class="blockly-placeholder">
                    <h3 style="color:var(--secondary-color)">Blockly View (Coming in V2)</h3>
                    <p>A future version will include a drag-and-drop interface here to build logic visually.</p>
                </div>
                <div>
                    <h3>Pseudocode / Javascript</h3>
                    <textarea id="pseudocode-editor" placeholder="// Example:&#10;// 1. FOR EACH row in 'Customers' table&#10;// 2. IF 'last_purchase_date' < 90 days ago&#10;// 3.    ADD customer_id to 'ActiveCustomers' table"></textarea>
                </div>
            </div>
        </div>


        <!-- Navigation -->
        <div class="navigation-buttons">
            <button id="prev-btn" class="btn btn-secondary" style="display: none;">Previous</button>
            <div>
                <button id="finish-btn" class="btn btn-success" style="display: none;">Finish & Review</button>
                <button id="next-btn" class="btn btn-primary">Next</button>
            </div>
        </div>
    </div>

    <!-- Modal for Table Data Editor -->
    <div id="data-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-table-name">Edit Table Data</h2>
            <p>You can edit data directly in the grid or use the CSV text area. The two views are synchronized.</p>
            <div class="modal-views">
                <div>
                    <h3>HTML View</h3>
                    <div class="data-table-container"><table id="modal-html-table" class="data-table"></table></div>
                     <button class="btn btn-light" onclick="app.addTableRow()">+ Add Row</button>
                </div>
                <div>
                    <h3>CSV View (comma-separated)</h3>
                    <textarea id="modal-csv-textarea" style="height: 400px; font-family: monospace;"></textarea>
                </div>
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                 <button class="btn btn-primary" onclick="app.saveTableData()">Save & Close</button>
                 <button class="btn btn-secondary" onclick="app.closeDataEditor()">Cancel</button>
            </div>
        </div>
    </div>

<script>
(function() {
    // --- Application State and Data Model ---
    const state = {
        currentStep: 1,
        maxSteps: 6,
        procedure: {
            name: '',
            summary: '',
            inputTables: [],
            outputTables: [],
            samples: [], // NEW
            pseudocode: '' // NEW
        },
        allTables: new Map(), // Stores table DEFINITIONS (name, columns)
        // NEW: Context for the data editor modal
        editingContext: {
            sampleId: null,
            tableDefId: null,
            isSampleData: false,
        },
        lastDataViewEdited: 'html'
    };

    // --- DOM Elements ---
    const stepElements = Array.from({length: state.maxSteps}, (_, i) => document.getElementById(`step-${i + 1}`));
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const finishBtn = document.getElementById('finish-btn');
    // Step 1
    const procNameInput = document.getElementById('proc-name');
    const procSummaryInput = document.getElementById('proc-summary');
    // Step 6
    const pseudocodeEditor = document.getElementById('pseudocode-editor');


    // --- The 'app' object exposes public methods to the HTML ---
    window.app = {
        // --- Wizard Navigation ---
        changeStep: function(direction) {
            this.updateModelFromUI();
            const newStep = state.currentStep + direction;
            if (newStep < 1 || newStep > state.maxSteps) return;
            this.goToStep(newStep);
        },

        goToStep: function(targetStep) {
            if (targetStep < 1 || targetStep > state.maxSteps) return;
            
            // Allow jumping back, but only forward one step at a time
            // Or allow jumping anywhere if already visited
            const maxReachableStep = Math.max(...Array.from(document.querySelectorAll('.progress-step.completed')).map(el => parseInt(el.dataset.step, 10)), 1);
            if (targetStep > state.currentStep + 1 && targetStep > maxReachableStep + 1) {
                 // Prevent jumping ahead over unvisited steps.
                 return;
            }

            this.updateModelFromUI();
            state.currentStep = targetStep;
            this.renderStep();
        },

        renderStep: function() {
            stepElements.forEach((el, index) => {
                el.classList.toggle('active', index + 1 === state.currentStep);
            });

            this.updateProgressTracker();

            // Navigation button visibility
            prevBtn.style.display = state.currentStep > 1 ? 'inline-block' : 'none';
            nextBtn.style.display = state.currentStep < state.maxSteps ? 'inline-block' : 'none';
            
            // The "Finish & Review" button takes you to Step 4.
            const isReviewable = state.currentStep === 3 || state.currentStep === 5 || state.currentStep === 6;
            finishBtn.style.display = isReviewable ? 'inline-block' : 'none';
            if(state.currentStep === 4) {
                 nextBtn.style.display = 'inline-block'; // Allow moving from Review to optional steps
                 finishBtn.style.display = 'none';
            }
             if (state.currentStep === state.maxSteps) {
                nextBtn.style.display = 'none';
            }


            // Call step-specific render functions
            if (state.currentStep === 4) this.generateFinalOutput();
            if (state.currentStep === 5) this.renderSamplesStep();
        },

        updateProgressTracker: function() {
            const progressSteps = document.querySelectorAll('.progress-step');
            const progressLine = document.querySelector('.progress-line-filled');
            
            progressSteps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < state.currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === state.currentStep) {
                    step.classList.add('active');
                }
            });
            
            const progressPercentage = ((state.currentStep - 1) / (state.maxSteps - 1)) * 100;
            progressLine.style.setProperty('--progress-width', `${progressPercentage}%`);
        },

        // --- Table Definition Management (Steps 2 & 3) ---
        addTable: function(tableType) {
            const tableId = `table-def-${Date.now()}`;
            const newTable = { id: tableId, name: `New ${tableType} Table`, columns: [], type: tableType };
            state.allTables.set(tableId, newTable);
            if (tableType === 'input') state.procedure.inputTables.push(newTable);
            else state.procedure.outputTables.push(newTable);
            
            document.getElementById(`${tableType}-tables-container`).insertAdjacentHTML('beforeend', this.createTableDefHTML(newTable));
        },
        
        removeTable: function(tableId) {
            const table = state.allTables.get(tableId);
            if (!table) return;

            state.procedure.inputTables = state.procedure.inputTables.filter(t => t.id !== tableId);
            state.procedure.outputTables = state.procedure.outputTables.filter(t => t.id !== tableId);
            state.allTables.delete(tableId);

            document.getElementById(tableId).remove();
        },

        addColumn: function(tableId) {
            const table = state.allTables.get(tableId);
            if (!table) return;
            const newColumn = { name: '', type: 'string(50)' };
            table.columns.push(newColumn);
            const container = document.querySelector(`#${tableId} .columns-container`);
            container.insertAdjacentHTML('beforeend', this.createColumnHTML(tableId, table.columns.length - 1));
        },
        
        removeColumn: function(tableId, columnIndex) {
            const table = state.allTables.get(tableId);
            if (!table) return;
            table.columns.splice(columnIndex, 1);
            // Simple re-render of columns for the affected table
            const container = document.querySelector(`#${tableId} .columns-container`);
            container.innerHTML = table.columns.map((_, i) => this.createColumnHTML(tableId, i)).join('');
        },
        
        // --- Sample Management (Step 5) ---
        addSample: function() {
            this.updateModelFromUI(); // Ensure table defs are up to date
            const sampleId = `sample-${Date.now()}`;
            const newSample = {
                id: sampleId,
                name: `Sample Case ${state.procedure.samples.length + 1}`,
                summary: '',
                tableInstances: []
            };

            // For every defined table, create a corresponding data instance in the sample
            state.allTables.forEach(tableDef => {
                newSample.tableInstances.push({
                    definitionId: tableDef.id,
                    data: [] // Initially empty data
                });
            });

            state.procedure.samples.push(newSample);
            this.renderSamplesStep();
        },

        removeSample: function(sampleId) {
            state.procedure.samples = state.procedure.samples.filter(s => s.id !== sampleId);
            this.renderSamplesStep();
        },

        renderSamplesStep: function() {
            const container = document.getElementById('samples-container');
            container.innerHTML = state.procedure.samples.map(sample => this.createSampleHTML(sample)).join('');
        },

        // --- Data Model Synchronization ---
        updateModelFromUI: function() {
            // Step 1
            state.procedure.name = procNameInput.value;
            state.procedure.summary = procSummaryInput.value;

            // Steps 2 & 3
            state.allTables.forEach(table => {
                const el = document.getElementById(table.id);
                if (!el) return;
                table.name = el.querySelector('.table-name-input').value;
                table.columns.forEach((col, i) => {
                    const colEl = el.querySelector(`.column-definition[data-column-index='${i}']`);
                    col.name = colEl.querySelector('.column-name-input').value;
                    col.type = colEl.querySelector('.column-type-select').value;
                });
            });

            // Step 5
            state.procedure.samples.forEach(sample => {
                const el = document.getElementById(sample.id);
                if (!el) return;
                sample.name = el.querySelector('.sample-name-input').value;
                sample.summary = el.querySelector('.sample-summary-input').value;
            });

            // Step 6
            state.procedure.pseudocode = pseudocodeEditor.value;
        },

        // --- Data Editor Modal (Now Context-Aware) ---
        openDataEditor: function(sampleId, tableDefId) {
            this.updateModelFromUI();
            state.editingContext = { sampleId, tableDefId, isSampleData: true };
            
            const tableDef = state.allTables.get(tableDefId);
            const sample = state.procedure.samples.find(s => s.id === sampleId);
            const tableInstance = sample.tableInstances.find(inst => inst.definitionId === tableDefId);
            
            if (!tableDef || !sample || !tableInstance) return;

            document.getElementById('modal-table-name').textContent = `Edit Data for: ${tableDef.name} (in ${sample.name})`;
            this.renderDataEditorViews(tableDef.columns, tableInstance.data);
            document.getElementById('data-editor-modal').style.display = 'flex';
        },

        closeDataEditor: function() {
            document.getElementById('data-editor-modal').style.display = 'none';
            state.editingContext = { sampleId: null, tableDefId: null, isSampleData: false };
        },

        saveTableData: function() {
            if (!state.editingContext.isSampleData) return;

            const { sampleId, tableDefId } = state.editingContext;
            const sample = state.procedure.samples.find(s => s.id === sampleId);
            const tableInstance = sample.tableInstances.find(inst => inst.definitionId === tableDefId);

            if (state.lastDataViewEdited === 'csv') {
                this.syncCsvToData(tableInstance);
            } else {
                this.syncHtmlToData(tableInstance);
            }
            this.closeDataEditor();
        },
        
        addTableRow: function() {
            const { sampleId, tableDefId } = state.editingContext;
            const tableDef = state.allTables.get(tableDefId);
            const sample = state.procedure.samples.find(s => s.id === sampleId);
            const tableInstance = sample.tableInstances.find(inst => inst.definitionId === tableDefId);
            
            tableInstance.data.push(Array(tableDef.columns.length).fill(''));
            this.renderDataEditorViews(tableDef.columns, tableInstance.data);
        },
        
        renderDataEditorViews: function(columns, data) {
            this.renderHtmlTableView(columns, data);
            this.renderCsvView(data);
        },

        renderHtmlTableView: function(columns, data) {
            const tableEl = document.getElementById('modal-html-table');
            let html = `<thead><tr>${columns.map(c => `<th>${this.escapeHtml(c.name || '(unnamed)')} (${c.type})</th>`).join('')}</tr></thead><tbody>`;
            data.forEach(row => {
                html += `<tr>${row.map(cell => `<td contenteditable="true">${this.escapeHtml(cell)}</td>`).join('')}`;
                for (let i = row.length; i < columns.length; i++) html += `<td contenteditable="true"></td>`;
                html += `</tr>`;
            });
            tableEl.innerHTML = html + `</tbody>`;
        },

        renderCsvView: function(data) {
            const csvTextarea = document.getElementById('modal-csv-textarea');
            csvTextarea.value = data.map(row => 
                row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        },

        syncHtmlToData: function(tableInstance) {
            const rows = Array.from(document.getElementById('modal-html-table').querySelectorAll('tbody tr'));
            tableInstance.data = rows.map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent));
        },

        syncCsvToData: function(tableInstance) {
            const lines = document.getElementById('modal-csv-textarea').value.split('\n');
            tableInstance.data = lines.filter(l => l.trim() !== '').map(l => l.split(',').map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"')));
        },

        // --- Final Output and Export ---
        generateFinalOutput: function() {
            this.updateModelFromUI();
            
            // Create a deep clone for manipulation
            const finalObject = JSON.parse(JSON.stringify(state.procedure)); 

            // Clean up internal IDs and structure for export
            const cleanTable = ({ name, columns }) => ({ name, columns });
            finalObject.inputTables = finalObject.inputTables.map(cleanTable);
            finalObject.outputTables = finalObject.outputTables.map(cleanTable);
            
            // Make samples more readable by replacing definitionId with table name
            finalObject.samples.forEach(sample => {
                delete sample.id;
                const newTableInstances = {};
                sample.tableInstances.forEach(inst => {
                    const tableDef = state.allTables.get(inst.definitionId);
                    if (tableDef) {
                        newTableInstances[tableDef.name] = inst.data;
                    }
                });
                sample.tables = newTableInstances;
                delete sample.tableInstances;
            });
            
            const jsonString = JSON.stringify(finalObject, null, 2);
            document.getElementById('json-output').textContent = jsonString;

            try {
                document.getElementById('yaml-output').textContent = jsyaml.dump(finalObject);
            } catch (e) {
                document.getElementById('yaml-output').textContent = `Error generating YAML: ${e.message}`;
            }
        },

        exportFile: function(format) {
            this.generateFinalOutput();
            let content = format === 'json' ? document.getElementById('json-output').textContent : document.getElementById('yaml-output').textContent;
            let mimeType = format === 'json' ? 'application/json' : 'application/x-yaml';
            let filename = `${state.procedure.name.replace(/ /g, '_') || 'procedure'}.${format}`;

            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        },

        // --- HTML Generation ---
        createTableDefHTML: function(table) {
            return `
                <div class="definition-card" id="${table.id}">
                    <div class="card-header">
                        <input type="text" class="table-name-input" value="${this.escapeHtml(table.name)}" placeholder="Table Name">
                        <button class="btn btn-danger" onclick="app.removeTable('${table.id}')">Remove</button>
                    </div>
                    <strong>Columns:</strong>
                    <div class="columns-container">${table.columns.map((_, i) => this.createColumnHTML(table.id, i)).join('')}</div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="app.addColumn('${table.id}')">+ Add Column</button>
                </div>`;
        },

        createColumnHTML: function(tableId, index) {
            const col = state.allTables.get(tableId).columns[index];
            return `
                <div class="column-definition" data-column-index="${index}">
                    <input type="text" class="column-name-input" value="${this.escapeHtml(col.name)}" placeholder="Column Name">
                    <select class="column-type-select">
                        <option value="string(50)" ${col.type === 'string(50)' ? 'selected' : ''}>string(50)</option>
                        <option value="int" ${col.type === 'int' ? 'selected' : ''}>int</option>
                        <option value="float" ${col.type === 'float' ? 'selected' : ''}>float</option>
                    </select>
                    <button class="btn btn-danger btn-sm" onclick="app.removeColumn('${tableId}', ${index})">X</button>
                </div>`;
        },

        createSampleHTML: function(sample) {
            this.updateModelFromUI(); // Ensure table names are fresh
            return `
            <div class="definition-card" id="${sample.id}">
                <div class="card-header">
                    <input type="text" class="sample-name-input" value="${this.escapeHtml(sample.name)}">
                    <button class="btn btn-danger" onclick="app.removeSample('${sample.id}')">Remove Sample</button>
                </div>
                <div class="form-group">
                    <label>Sample Summary</label>
                    <textarea class="sample-summary-input" placeholder="Describe this specific test case.">${this.escapeHtml(sample.summary)}</textarea>
                </div>
                <h3>Table Data for this Sample</h3>
                ${sample.tableInstances.map(inst => {
                    const tableDef = state.allTables.get(inst.definitionId);
                    if (!tableDef) return ''; // Skip if definition was deleted
                    return `
                        <div class="sample-table-instance">
                            <h4>${this.escapeHtml(tableDef.name)} <span style="font-weight:normal;color:#999;">(${tableDef.type})</span></h4>
                            <button class="btn btn-light" onclick="app.openDataEditor('${sample.id}', '${tableDef.id}')">Define/Edit Data</button>
                        </div>
                    `;
                }).join('')}
            </div>`;
        },

        // --- Utilities & Initializer ---
        escapeHtml: (str) => String(str || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"),

        init: function() {
            this.renderStep();
            // Bind navigation
            nextBtn.addEventListener('click', () => this.changeStep(1));
            finishBtn.addEventListener('click', () => this.goToStep(4));
            prevBtn.addEventListener('click', () => this.changeStep(-1));
            // Add first sample automatically if none exist when user hits step 5
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'class' && state.currentStep === 5 && state.procedure.samples.length === 0) {
                        this.addSample();
                    }
                });
            });
            observer.observe(document.getElementById('step-5'), { attributes: true });

            // Modal sync listeners
            const modalHtmlTable = document.getElementById('modal-html-table');
            const modalCsvTextarea = document.getElementById('modal-csv-textarea');
            modalHtmlTable.addEventListener('input', () => { state.lastDataViewEdited = 'html'; this.syncHtmlToData(this.getEditingInstance()); this.renderCsvView(this.getEditingInstance().data); });
            modalCsvTextarea.addEventListener('input', () => { state.lastDataViewEdited = 'csv'; this.syncCsvToData(this.getEditingInstance()); this.renderHtmlTableView(state.allTables.get(state.editingContext.tableDefId).columns, this.getEditingInstance().data); });
        },
        // Helper to get the current object being edited in the modal
        getEditingInstance: function() {
             const { sampleId, tableDefId } = state.editingContext;
             return state.procedure.samples.find(s => s.id === sampleId).tableInstances.find(i => i.definitionId === tableDefId);
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
})();
</script>

</body>
</html>